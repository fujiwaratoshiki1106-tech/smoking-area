<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>博多駅タバコ吸うならここ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>博多駅タバコ吸うならここ</h1>

  <div class="filters">
    <select id="category-filter">
      <option value="">カテゴリを選択</option>
      <option value="カフェ">カフェ</option>
      <option value="喫茶店">喫茶店</option>
      <option value="居酒屋">居酒屋</option>
    </select>
    <select id="smoking-filter">
      <option value="">喫煙形態を選択</option>
      <option value="全席喫煙可">全席喫煙可</option>
      <option value="分煙">分煙</option>
      <option value="喫煙ブースあり">喫煙ブースあり</option>
    </select>
  </div>

  <div class="store-list" id="store-list">
    <!-- JSで店舗データを挿入 -->
  </div>

  <script>
<script>
  let stores = [];

  async function fetchStoresFromCSV() {
    const resp = await fetch('stores.csv');
    const text = await resp.text();

    // シンプルCSVパーサー（カンマ区切り前提、ダブルクオート未対応）
    const rows = text.trim().split('\n').map(r => r.split(','));
    const headers = rows[0].map(h => h.trim());
    const data = rows.slice(1).map(row => {
      const obj = {};
      headers.forEach((key, i) => obj[key] = (row[i] || '').trim());
      return obj;
    });
    stores = data;
    renderStores();
  }

  function getSmokingIcon(type) {
    switch (type) {
      case "全席喫煙可": return "🚬";
      case "分煙": return "🚷";
      case "喫煙ブースあり": return "🚪💨";
      default: return "❓";
    }
  }

  // 営業中判定（"7:00-21:00" / "平日7:00-21:00;土日9:00-18:00" などに対応・ざっくり）
  function isOpenNow(openHoursRaw) {
    if (!openHoursRaw) return false;

    // 日本時間で判定
    const now = new Date();
    const jstNow = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
    const day = jstNow.getDay(); // 0=日, 6=土
    const hm = jstNow.getHours() * 60 + jstNow.getMinutes();

    const blocks = openHoursRaw.split(';').map(s => s.trim()).filter(Boolean);

    const pick = blocks.filter(b => {
      if (/平日/.test(b)) return day >= 1 && day <= 5;
      if (/土日/.test(b)) return day === 0 || day === 6;
      if (/土/.test(b) && !/土日/.test(b)) return day === 6;
      if (/日/.test(b) && !/土日/.test(b)) return day === 0;
      // 曜日指定がなければ常に候補
      return !/[月火水木金土日]/.test(b);
    });

    const candidates = (pick.length ? pick : blocks).map(b => {
      // 最初に見つかった 00:00-00:00 パターンを拾う
      const m = b.match(/(\d{1,2}):?(\d{2})?-(\d{1,2}):?(\d{2})?/);
      if (!m) return null;
      const s = parseInt(m[1], 10) * 60 + parseInt(m[2] || '0', 10);
      const e = parseInt(m[3], 10) * 60 + parseInt(m[4] || '0', 10);
      return { s, e };
    }).filter(Boolean);

    return candidates.some(({ s, e }) => {
      if (e < s) { // 日跨ぎ（例: 22:00-02:00）
        return hm >= s || hm <= e;
      }
      return hm >= s && hm <= e;
    });
  }

  const storeList = document.getElementById("store-list");
  const categoryFilter = document.getElementById("category-filter");
  const smokingFilter = document.getElementById("smoking-filter");

  function renderStores() {
    const category = categoryFilter.value;
    const smoking = smokingFilter.value;

    const filtered = stores.filter(st =>
      (!category || st.category === category) &&
      (!smoking || st.smoking === smoking)
    );

    storeList.innerHTML = "";

    if (!filtered.length) {
      const p = document.createElement("p");
      p.textContent = "該当するお店が見つかりませんでした。";
      p.style.textAlign = "center";
      storeList.appendChild(p);
      return;
    }

    filtered.forEach((st, i) => {
      const openNow = isOpenNow(st.openHours);

      const badgesHtml = `
        <div class="badges">
          ${st.priceRange ? `<span class="badge">${st.priceRange}</span>` : ""}
          ${st.seats ? `<span class="badge">席:${st.seats}</span>` : ""}
          ${st.powerOutlets && st.powerOutlets.toLowerCase() === "yes" ? `<span class="badge">🔌電源</span>` : ""}
          ${st.wifi && st.wifi.toLowerCase() === "yes" ? `<span class="badge">📶Wi‑Fi</span>` : ""}
          ${openNow ? `<span class="badge badge-open">● 営業中</span>` : ""}
        </div>
      `;

      const card = document.createElement("div");
      card.className = "store-card fade-in";
      card.style.animationDelay = `${i * 50}ms`;
      card.innerHTML = `
        <h3>${st.name}<span class="smoking-icon">${getSmokingIcon(st.smoking)}</span></h3>
        ${badgesHtml}
        <p>カテゴリ：${st.category || "-"}</p>
        <p>喫煙形態：${st.smoking || "-"}</p>
        <p>住所：${st.address || "-"}</p>
        <p><a href="${st.mapUrl || "#"}" target="_blank" rel="noopener">Google Mapで見る</a></p>
      `;
      storeList.appendChild(card);
    });
  }

  categoryFilter.addEventListener("change", renderStores);
  smokingFilter.addEventListener("change", renderStores);

  fetchStoresFromCSV();
</script>

  </script>
</body>
</html>

<script>
  console.log("JS OK");
  document.addEventListener('DOMContentLoaded', () => {
    const el = document.createElement('div');
    el.textContent = 'JSロードOK';
    el.style.textAlign = 'center';
    document.body.appendChild(el);
  });
</script>
