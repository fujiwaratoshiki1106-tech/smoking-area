<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>åšå¤šé§…ã‚¿ãƒã‚³å¸ã†ãªã‚‰ã“ã“</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>åšå¤šé§…ã‚¿ãƒã‚³å¸ã†ãªã‚‰ã“ã“</h1>

  <div class="filters">
    <select id="category-filter">
      <option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</option>
      <option value="ã‚«ãƒ•ã‚§">ã‚«ãƒ•ã‚§</option>
      <option value="å–«èŒ¶åº—">å–«èŒ¶åº—</option>
      <option value="å±…é…’å±‹">å±…é…’å±‹</option>
    </select>
    <select id="smoking-filter">
      <option value="">å–«ç…™å½¢æ…‹ã‚’é¸æŠ</option>
      <option value="å…¨å¸­å–«ç…™å¯">å…¨å¸­å–«ç…™å¯</option>
      <option value="åˆ†ç…™">åˆ†ç…™</option>
      <option value="å–«ç…™ãƒ–ãƒ¼ã‚¹ã‚ã‚Š">å–«ç…™ãƒ–ãƒ¼ã‚¹ã‚ã‚Š</option>
    </select>
  </div>

  <div class="store-list" id="store-list">
    <!-- JSã§åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥ -->
  </div>

  <script>
<script>
  let stores = [];

  async function fetchStoresFromCSV() {
    const resp = await fetch('stores.csv');
    const text = await resp.text();

    // ã‚·ãƒ³ãƒ—ãƒ«CSVãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šå‰æã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚ªãƒ¼ãƒˆæœªå¯¾å¿œï¼‰
    const rows = text.trim().split('\n').map(r => r.split(','));
    const headers = rows[0].map(h => h.trim());
    const data = rows.slice(1).map(row => {
      const obj = {};
      headers.forEach((key, i) => obj[key] = (row[i] || '').trim());
      return obj;
    });
    stores = data;
    renderStores();
  }

  function getSmokingIcon(type) {
    switch (type) {
      case "å…¨å¸­å–«ç…™å¯": return "ğŸš¬";
      case "åˆ†ç…™": return "ğŸš·";
      case "å–«ç…™ãƒ–ãƒ¼ã‚¹ã‚ã‚Š": return "ğŸšªğŸ’¨";
      default: return "â“";
    }
  }

  // å–¶æ¥­ä¸­åˆ¤å®šï¼ˆ"7:00-21:00" / "å¹³æ—¥7:00-21:00;åœŸæ—¥9:00-18:00" ãªã©ã«å¯¾å¿œãƒ»ã–ã£ãã‚Šï¼‰
  function isOpenNow(openHoursRaw) {
    if (!openHoursRaw) return false;

    // æ—¥æœ¬æ™‚é–“ã§åˆ¤å®š
    const now = new Date();
    const jstNow = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
    const day = jstNow.getDay(); // 0=æ—¥, 6=åœŸ
    const hm = jstNow.getHours() * 60 + jstNow.getMinutes();

    const blocks = openHoursRaw.split(';').map(s => s.trim()).filter(Boolean);

    const pick = blocks.filter(b => {
      if (/å¹³æ—¥/.test(b)) return day >= 1 && day <= 5;
      if (/åœŸæ—¥/.test(b)) return day === 0 || day === 6;
      if (/åœŸ/.test(b) && !/åœŸæ—¥/.test(b)) return day === 6;
      if (/æ—¥/.test(b) && !/åœŸæ—¥/.test(b)) return day === 0;
      // æ›œæ—¥æŒ‡å®šãŒãªã‘ã‚Œã°å¸¸ã«å€™è£œ
      return !/[æœˆç«æ°´æœ¨é‡‘åœŸæ—¥]/.test(b);
    });

    const candidates = (pick.length ? pick : blocks).map(b => {
      // æœ€åˆã«è¦‹ã¤ã‹ã£ãŸ 00:00-00:00 ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ‹¾ã†
      const m = b.match(/(\d{1,2}):?(\d{2})?-(\d{1,2}):?(\d{2})?/);
      if (!m) return null;
      const s = parseInt(m[1], 10) * 60 + parseInt(m[2] || '0', 10);
      const e = parseInt(m[3], 10) * 60 + parseInt(m[4] || '0', 10);
      return { s, e };
    }).filter(Boolean);

    return candidates.some(({ s, e }) => {
      if (e < s) { // æ—¥è·¨ãï¼ˆä¾‹: 22:00-02:00ï¼‰
        return hm >= s || hm <= e;
      }
      return hm >= s && hm <= e;
    });
  }

  const storeList = document.getElementById("store-list");
  const categoryFilter = document.getElementById("category-filter");
  const smokingFilter = document.getElementById("smoking-filter");

  function renderStores() {
    const category = categoryFilter.value;
    const smoking = smokingFilter.value;

    const filtered = stores.filter(st =>
      (!category || st.category === category) &&
      (!smoking || st.smoking === smoking)
    );

    storeList.innerHTML = "";

    if (!filtered.length) {
      const p = document.createElement("p");
      p.textContent = "è©²å½“ã™ã‚‹ãŠåº—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
      p.style.textAlign = "center";
      storeList.appendChild(p);
      return;
    }

    filtered.forEach((st, i) => {
      const openNow = isOpenNow(st.openHours);

      const badgesHtml = `
        <div class="badges">
          ${st.priceRange ? `<span class="badge">${st.priceRange}</span>` : ""}
          ${st.seats ? `<span class="badge">å¸­:${st.seats}</span>` : ""}
          ${st.powerOutlets && st.powerOutlets.toLowerCase() === "yes" ? `<span class="badge">ğŸ”Œé›»æº</span>` : ""}
          ${st.wifi && st.wifi.toLowerCase() === "yes" ? `<span class="badge">ğŸ“¶Wiâ€‘Fi</span>` : ""}
          ${openNow ? `<span class="badge badge-open">â— å–¶æ¥­ä¸­</span>` : ""}
        </div>
      `;

      const card = document.createElement("div");
      card.className = "store-card fade-in";
      card.style.animationDelay = `${i * 50}ms`;
      card.innerHTML = `
        <h3>${st.name}<span class="smoking-icon">${getSmokingIcon(st.smoking)}</span></h3>
        ${badgesHtml}
        <p>ã‚«ãƒ†ã‚´ãƒªï¼š${st.category || "-"}</p>
        <p>å–«ç…™å½¢æ…‹ï¼š${st.smoking || "-"}</p>
        <p>ä½æ‰€ï¼š${st.address || "-"}</p>
        <p><a href="${st.mapUrl || "#"}" target="_blank" rel="noopener">Google Mapã§è¦‹ã‚‹</a></p>
      `;
      storeList.appendChild(card);
    });
  }

  categoryFilter.addEventListener("change", renderStores);
  smokingFilter.addEventListener("change", renderStores);

  fetchStoresFromCSV();
</script>

  </script>
</body>
</html>

<script>
  console.log("JS OK");
  document.addEventListener('DOMContentLoaded', () => {
    const el = document.createElement('div');
    el.textContent = 'JSãƒ­ãƒ¼ãƒ‰OK';
    el.style.textAlign = 'center';
    document.body.appendChild(el);
  });
</script>
